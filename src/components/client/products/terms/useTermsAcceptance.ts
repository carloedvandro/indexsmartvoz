
import { useState } from "react";
import { useToast } from "@/hooks/use-toast";
import { supabase } from "@/integrations/supabase/client";

interface UseTermsAcceptanceProps {
  onAccept?: (accepted: boolean) => void;
  onClose: () => void;
}

export function useTermsAcceptance({ onAccept, onClose }: UseTermsAcceptanceProps) {
  const [aceito, setAceito] = useState(false);
  const [enviando, setEnviando] = useState(false);
  const { toast } = useToast();

  const handleAceite = async () => {
    try {
      setEnviando(true);
      
      console.log('üîÑ Tentando registrar aceite dos termos...');
      
      // Verificar se o usu√°rio est√° logado
      const { data: { session } } = await supabase.auth.getSession();
      
      if (!session) {
        throw new Error('Usu√°rio n√£o est√° logado');
      }

      console.log('‚úÖ Usu√°rio logado, enviando aceite...');
      
      // Registrar aceite via Edge Function
      const { data, error } = await supabase.functions.invoke('registro-termo', {
        body: {
          aceite: true,
          receberComunicados: true
        }
      });

      console.log('üì§ Resposta da fun√ß√£o:', { data, error });

      if (error) {
        console.error('‚ùå Erro na fun√ß√£o:', error);
        throw error;
      }

      console.log('‚úÖ Aceite registrado com sucesso');
      
      toast({
        title: "Sucesso",
        description: "Aceite registrado com sucesso.",
      });
      
      if (onAccept) {
        onAccept(true);
      }
      
      onClose();
    } catch (error) {
      console.error('‚ùå Erro ao registrar aceite:', error);
      toast({
        title: "Erro",
        description: "Erro ao registrar o aceite. Tente novamente.",
        variant: "destructive",
      });
    } finally {
      setEnviando(false);
    }
  };

  return {
    aceito,
    setAceito,
    enviando,
    handleAceite
  };
}
